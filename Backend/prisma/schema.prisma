// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Client {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique  // "sports-club-juarez" for URLs
  email       String   @unique
  phone       String?
  logoUrl     String?
  active      Boolean  @default(true)
  
  // Payment config per client
  paymentMode PaymentMode @default(BOTH)
  currency    String      @default("MXN")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  memberships     Membership[]
  resourceTypes   ResourceType[]
  resources       Resource[]
  bookings        Booking[]
  notifications   Notification[]
}

model User {
  id          String   @id // Same UUID as Supabase Auth
  name        String
  email       String   @unique
  phone       String?
  avatarUrl   String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  memberships   Membership[]
  bookings      Booking[]
  payments      Payment[]
  notifications Notification[]
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  clientId  String
  role      Role     @default(CUSTOMER)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  client Client @relation(fields: [clientId], references: [id])

  @@unique([userId, clientId]) // One membership per user per client
}

// ============================================
// RESOURCE LAYER
// ============================================

model ResourceType {
  id          String  @id @default(cuid())
  clientId    String
  name        String  // "Football Field", "Studio Room", "Desk"
  description String?
  icon        String? // optional icon slug

  client    Client     @relation(fields: [clientId], references: [id])
  resources Resource[]

  @@unique([clientId, name])
}

model Resource {
  id             String   @id @default(cuid())
  clientId       String
  resourceTypeId String
  name           String   // "Field 1", "Studio A"
  description    String?
  pricePerHour   Decimal  @db.Decimal(10, 2)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  client       Client       @relation(fields: [clientId], references: [id])
  resourceType ResourceType @relation(fields: [resourceTypeId], references: [id])
  schedules    ResourceSchedule[]
  blocks       ResourceBlock[]
  bookings     Booking[]
}

model ResourceSchedule {
  id           String @id @default(cuid())
  resourceId   String
  dayOfWeek    Int    // 1=Mon, 7=Sun
  openTime     String // "08:00"
  closeTime    String // "22:00"

  resource Resource @relation(fields: [resourceId], references: [id])

  @@unique([resourceId, dayOfWeek])
}

model ResourceBlock {
  id         String   @id @default(cuid())
  resourceId String
  date       DateTime @db.Date
  startTime  String   // "09:00"
  endTime    String   // "11:00"
  reason     String?  // "Maintenance", "Private event"

  resource Resource @relation(fields: [resourceId], references: [id])
}

// ============================================
// BOOKING LAYER
// ============================================

model Booking {
  id         String        @id @default(cuid())
  clientId   String
  userId     String
  resourceId String
  date       DateTime      @db.Date
  startTime  String        // "14:00"
  endTime    String        // "16:00"
  totalPrice Decimal       @db.Decimal(10, 2) // price locked at booking time
  status     BookingStatus @default(PENDING)
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  client   Client   @relation(fields: [clientId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  resource Resource @relation(fields: [resourceId], references: [id])
  payment  Payment?

  @@index([resourceId, date]) // Fast overlap queries
}

// ============================================
// PAYMENT LAYER
// ============================================

model Payment {
  id            String        @id @default(cuid())
  bookingId     String        @unique
  userId        String
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  referenceCode String?       // external payment gateway ref
  createdAt     DateTime      @default(now())

  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
}

// ============================================
// NOTIFICATION LAYER
// ============================================

model Notification {
  id        String             @id @default(cuid())
  clientId  String
  userId    String
  type      NotificationType
  channel   NotificationChannel
  subject   String?
  body      String
  sentAt    DateTime?
  read      Boolean            @default(false)
  createdAt DateTime           @default(now())

  client Client @relation(fields: [clientId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
}

// ============================================
// ENUMS
// ============================================

enum Role {
  SUPERADMIN  // Your SaaS admin (you)
  ADMIN       // Company admin
  STAFF       // Company employee
  CUSTOMER    // End user booking
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentMode {
  ONLINE
  ON_ARRIVAL
  BOTH
}

enum PaymentMethod {
  CARD
  CASH
  TRANSFER
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  BOOKING_REMINDER
  PAYMENT_RECEIVED
}

enum NotificationChannel {
  EMAIL
  SMS
  IN_APP
}